{
  "id": "bloodissuance",
  "title": "Blood Issuance",
  "description": "Handles the issuance of blood units to patients, ensuring traceability between donor, inventory, request, and billing. Records transfusion details, approvals, and status tracking.",
  "entity": "BloodIssuance",
  "icon": "activity",
  "version": "1.0.0",
  "module": "Blood Bank Management",

  "permissions": {
    "view": ["Admin", "LabTechnician", "Doctor", "Accountant"],
    "create": ["LabTechnician", "Admin"],
    "edit": ["LabTechnician", "Admin"],
    "delete": ["Admin"]
  },

  "api": {
    "base": "/api/bloodbank/issuance",
    "endpoints": {
      "list": { "method": "GET", "path": "/" },
      "get": { "method": "GET", "path": "/:id" },
      "create": { "method": "POST", "path": "/" },
      "update": { "method": "PUT", "path": "/:id" },
      "delete": { "method": "DELETE", "path": "/:id" },
      "receipt": { "method": "GET", "path": "/:id/receipt" }
    }
  },

  "fields": [
    { "name": "id", "label": "Issuance ID", "type": "uuid", "primary": true, "autoGenerated": true },

    {
      "name": "issueCode",
      "label": "Issue Code",
      "type": "string",
      "unique": true,
      "required": true,
      "placeholder": "Auto-generated unique code (e.g., BISS-0001)",
      "showInList": true
    },
    {
      "name": "requestId",
      "label": "Linked Request",
      "type": "relation",
      "relationEntity": "bloodrequests",
      "relationField": "requestCode",
      "widget": "select",
      "required": true,
      "showInList": true
    },
    {
      "name": "patientId",
      "label": "Patient",
      "type": "relation",
      "relationEntity": "patients",
      "relationField": "fullName",
      "widget": "select",
      "required": true,
      "showInList": true
    },
    {
      "name": "doctorId",
      "label": "Prescribed By (Doctor)",
      "type": "relation",
      "relationEntity": "doctors",
      "relationField": "fullName",
      "widget": "select"
    },
    {
      "name": "bloodGroup",
      "label": "Blood Group",
      "type": "enum",
      "options": ["A+", "A-", "B+", "B-", "O+", "O-", "AB+", "AB-"],
      "required": true,
      "widget": "select",
      "showInList": true
    },
    {
      "name": "componentType",
      "label": "Component Type",
      "type": "enum",
      "options": ["Whole Blood", "Plasma", "Platelets", "RBC", "Cryoprecipitate"],
      "default": "Whole Blood",
      "widget": "select",
      "showInList": true
    },
    {
      "name": "unitsIssued",
      "label": "Units Issued",
      "type": "number",
      "min": 1,
      "default": 1,
      "showInList": true
    },
    {
      "name": "issuedUnits",
      "label": "Blood Units",
      "type": "array",
      "subFields": [
        {
          "name": "unitId",
          "label": "Unit Code",
          "type": "relation",
          "relationEntity": "bloodinventory",
          "relationField": "unitCode",
          "widget": "select"
        },
        { "name": "componentType", "label": "Component", "type": "string" },
        { "name": "volume", "label": "Volume (ml)", "type": "number" }
      ],
      "showInList": false
    },
    {
      "name": "issueDate",
      "label": "Issued On",
      "type": "datetime",
      "default": "now",
      "showInList": true
    },
    {
      "name": "issuedBy",
      "label": "Issued By (Technician)",
      "type": "relation",
      "relationEntity": "LabTechnician",
      "relationField": "fullName",
      "widget": "select",
      "showInList": true
    },
    {
      "name": "receivedBy",
      "label": "Received By",
      "type": "string",
      "placeholder": "Name of nurse/representative"
    },
    {
      "name": "verificationStatus",
      "label": "Crossmatch Verification",
      "type": "enum",
      "options": ["Pending", "Verified", "Incompatible"],
      "default": "Pending",
      "widget": "select",
      "showInList": true
    },
    {
      "name": "issueStatus",
      "label": "Status",
      "type": "enum",
      "options": ["Issued", "Returned", "Discarded"],
      "default": "Issued",
      "showInList": true
    },
    {
      "name": "charges",
      "label": "Issuance Charge (â‚¹)",
      "type": "number",
      "default": 0,
      "step": "0.01",
      "showInList": true
    },
    {
      "name": "paymentStatus",
      "label": "Payment Status",
      "type": "enum",
      "options": ["Unpaid", "Paid", "Waived"],
      "default": "Unpaid",
      "widget": "badge",
      "showInList": true
    },
    {
      "name": "remarks",
      "label": "Remarks / Notes",
      "type": "text",
      "widget": "textarea"
    },
    {
      "name": "createdAt",
      "label": "Created At",
      "type": "datetime",
      "readOnly": true
    },
    { "name": "updatedAt", "label": "Updated At", "type": "datetime", "readOnly": true }
  ],

  "relations": [
    { "entity": "bloodrequests", "type": "ManyToOne", "foreignKey": "requestId" },
    { "entity": "patients", "type": "ManyToOne", "foreignKey": "patientId" },
    { "entity": "doctors", "type": "ManyToOne", "foreignKey": "doctorId" },
    { "entity": "bloodinventory", "type": "ManyToMany", "foreignKey": "unitId" }
  ],

  "ui": {
    "listView": {
      "title": "Blood Issuance Records",
      "columns": ["issueCode", "patientId", "bloodGroup", "componentType", "unitsIssued", "issueDate", "issueStatus", "paymentStatus"],
      "filters": ["bloodGroup", "issueStatus", "paymentStatus"],
      "searchFields": ["issueCode", "patientId", "doctorId"],
      "actions": ["view", "edit", "delete", "printReceipt"]
    },
    "formView": {
      "title": "Add / Edit Blood Issuance",
      "layout": [
        ["issueCode", "issueDate"],
        ["requestId", "patientId", "doctorId"],
        ["bloodGroup", "componentType", "unitsIssued"],
        ["issuedUnits"],
        ["issuedBy", "receivedBy"],
        ["verificationStatus", "issueStatus"],
        ["charges", "paymentStatus"],
        ["remarks"]
      ],
      "actions": ["save", "reset", "cancel"]
    },
    "detailView": {
      "title": "Issuance Details",
      "sections": [
        {
          "title": "Request & Patient Info",
          "fields": ["issueCode", "requestId", "patientId", "doctorId", "issueDate", "issuedBy"]
        },
        {
          "title": "Issued Units",
          "fields": ["issuedUnits", "bloodGroup", "componentType", "unitsIssued"]
        },
        {
          "title": "Status & Financials",
          "fields": ["verificationStatus", "issueStatus", "charges", "paymentStatus", "remarks"]
        }
      ]
    }
  },

  "actions": [
    {
      "id": "printReceipt",
      "label": "Print Issuance Receipt",
      "type": "action",
      "method": "GET",
      "endpoint": "/api/bloodbank/issuance/:id/receipt",
      "openIn": "newTab",
      "successMessage": "Issuance receipt opened for print"
    },
    {
      "id": "markPaid",
      "label": "Mark as Paid",
      "type": "action",
      "method": "PATCH",
      "endpoint": "/api/bloodbank/issuance/:id/payment",
      "body": { "paymentStatus": "Paid" },
      "successMessage": "Payment marked as completed"
    },
    {
      "id": "returnUnit",
      "label": "Mark Unit as Returned",
      "type": "action",
      "method": "PATCH",
      "endpoint": "/api/bloodbank/issuance/:id/status",
      "body": { "issueStatus": "Returned" },
      "confirmation": "Confirm to mark the issued unit as returned?",
      "successMessage": "Unit return recorded successfully"
    }
  ],

  "businessLogic": {
    "rules": [
      "Issuance allowed only for approved requests with available reserved units.",
      "Linked bloodinventory units automatically marked as 'Issued' once issuance is completed.",
      "Crossmatch verification must be 'Verified' before issuance approval.",
      "Each issuance generates a billing record for finance reconciliation.",
      "Returned or discarded units are automatically reclassified in inventory with audit logs."
    ]
  },

  "reasoning": {
    "businessLogic": "Blood issuance finalizes the donation-to-transfusion chain. Full traceability ensures safety, accountability, and compliance with medical regulations.",
    "uiLogic": "Technicians issue or return units easily; accountants reconcile charges; administrators audit crossmatching and billing in one view."
  }
}
