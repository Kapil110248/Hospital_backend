{
  "id": "bloodrequests",
  "title": "Blood Requests",
  "description": "Handles internal and external requests for blood units, tracks approval, reservation, and linkage with issuance records for hospitals or departments.",
  "entity": "BloodRequest",
  "icon": "clipboard-list",
  "version": "1.0.0",
  "module": "Blood Bank Management",

  "permissions": {
    "view": ["Admin", "LabTechnician", "Doctor", "Nurse"],
    "create": ["Doctor", "LabTechnician", "Admin"],
    "edit": ["Admin", "LabTechnician"],
    "delete": ["Admin"]
  },

  "api": {
    "base": "/api/bloodbank/requests",
    "endpoints": {
      "list": { "method": "GET", "path": "/" },
      "get": { "method": "GET", "path": "/:id" },
      "create": { "method": "POST", "path": "/" },
      "update": { "method": "PUT", "path": "/:id" },
      "delete": { "method": "DELETE", "path": "/:id" },
      "approve": { "method": "PATCH", "path": "/:id/approve" },
      "reject": { "method": "PATCH", "path": "/:id/reject" }
    }
  },

  "fields": [
    { "name": "id", "label": "Request ID", "type": "uuid", "primary": true, "autoGenerated": true },

    {
      "name": "requestCode",
      "label": "Request Code",
      "type": "string",
      "unique": true,
      "required": true,
      "placeholder": "Auto-generated unique request code (e.g., BRQ-0001)",
      "showInList": true
    },
    {
      "name": "patientId",
      "label": "Patient",
      "type": "relation",
      "relationEntity": "patients",
      "relationField": "fullName",
      "widget": "select",
      "showInList": true
    },
    {
      "name": "doctorId",
      "label": "Requested By (Doctor)",
      "type": "relation",
      "relationEntity": "doctors",
      "relationField": "fullName",
      "widget": "select",
      "showInList": true
    },
    {
      "name": "departmentId",
      "label": "Department",
      "type": "relation",
      "relationEntity": "departments",
      "relationField": "name",
      "widget": "select",
      "showInList": true
    },
    {
      "name": "bloodGroup",
      "label": "Required Blood Group",
      "type": "enum",
      "options": ["A+", "A-", "B+", "B-", "O+", "O-", "AB+", "AB-"],
      "required": true,
      "widget": "select",
      "showInList": true
    },
    {
      "name": "componentType",
      "label": "Component Type",
      "type": "enum",
      "options": ["Whole Blood", "Plasma", "Platelets", "RBC", "Cryoprecipitate"],
      "default": "Whole Blood",
      "widget": "select",
      "showInList": true
    },
    {
      "name": "unitsRequested",
      "label": "Units Requested",
      "type": "number",
      "min": 1,
      "default": 1,
      "showInList": true
    },
    {
      "name": "urgencyLevel",
      "label": "Urgency Level",
      "type": "enum",
      "options": ["Normal", "Urgent", "Emergency"],
      "default": "Normal",
      "widget": "badge",
      "showInList": true
    },
    {
      "name": "purpose",
      "label": "Purpose / Diagnosis",
      "type": "text",
      "widget": "textarea",
      "placeholder": "Enter reason or diagnosis requiring transfusion"
    },
    {
      "name": "requestedDate",
      "label": "Requested On",
      "type": "datetime",
      "default": "now",
      "showInList": true
    },
    {
      "name": "approvedBy",
      "label": "Approved By",
      "type": "relation",
      "relationEntity": "LabTechnician",
      "relationField": "fullName",
      "widget": "select"
    },
    {
      "name": "approvalStatus",
      "label": "Approval Status",
      "type": "enum",
      "options": ["Pending", "Approved", "Rejected", "Completed"],
      "default": "Pending",
      "showInList": true
    },
    {
      "name": "linkedUnits",
      "label": "Reserved Units",
      "type": "array",
      "subFields": [
        {
          "name": "unitId",
          "label": "Blood Unit",
          "type": "relation",
          "relationEntity": "bloodinventory",
          "relationField": "unitCode",
          "widget": "select"
        },
        { "name": "bloodGroup", "label": "Group", "type": "string" },
        { "name": "componentType", "label": "Component", "type": "string" }
      ],
      "showInList": false
    },
    {
      "name": "statusRemarks",
      "label": "Remarks / Notes",
      "type": "text",
      "widget": "textarea"
    },
    {
      "name": "createdAt",
      "label": "Created At",
      "type": "datetime",
      "readOnly": true
    },
    { "name": "updatedAt", "label": "Updated At", "type": "datetime", "readOnly": true }
  ],

  "relations": [
    { "entity": "patients", "type": "ManyToOne", "foreignKey": "patientId" },
    { "entity": "doctors", "type": "ManyToOne", "foreignKey": "doctorId" },
    { "entity": "departments", "type": "ManyToOne", "foreignKey": "departmentId" },
    { "entity": "bloodinventory", "type": "OneToMany", "foreignKey": "linkedRequestId" },
    { "entity": "bloodissuance", "type": "OneToOne", "foreignKey": "requestId" }
  ],

  "ui": {
    "listView": {
      "title": "Blood Requests Overview",
      "columns": ["requestCode", "patientId", "bloodGroup", "componentType", "unitsRequested", "approvalStatus", "urgencyLevel"],
      "filters": ["bloodGroup", "approvalStatus", "urgencyLevel"],
      "searchFields": ["requestCode", "patientId", "doctorId", "departmentId"],
      "actions": ["view", "edit", "delete", "approve", "reject"]
    },
    "formView": {
      "title": "New Blood Request / Edit Request",
      "layout": [
        ["requestCode", "requestedDate"],
        ["patientId", "doctorId", "departmentId"],
        ["bloodGroup", "componentType", "unitsRequested"],
        ["urgencyLevel", "purpose"],
        ["approvalStatus", "statusRemarks"]
      ],
      "actions": ["save", "reset", "cancel"]
    },
    "detailView": {
      "title": "Request Details",
      "sections": [
        {
          "title": "Request Info",
          "fields": ["requestCode", "patientId", "doctorId", "departmentId", "requestedDate", "urgencyLevel"]
        },
        {
          "title": "Blood Details",
          "fields": ["bloodGroup", "componentType", "unitsRequested", "approvalStatus"]
        },
        {
          "title": "Reserved Units & Remarks",
          "fields": ["linkedUnits", "statusRemarks"]
        }
      ]
    }
  },

  "actions": [
    {
      "id": "approve",
      "label": "Approve Request",
      "type": "action",
      "method": "PATCH",
      "endpoint": "/api/bloodbank/requests/:id/approve",
      "body": { "approvalStatus": "Approved" },
      "successMessage": "Request approved and units reserved"
    },
    {
      "id": "reject",
      "label": "Reject Request",
      "type": "action",
      "method": "PATCH",
      "endpoint": "/api/bloodbank/requests/:id/reject",
      "body": { "approvalStatus": "Rejected" },
      "confirmation": "Are you sure you want to reject this request?",
      "successMessage": "Request rejected successfully"
    }
  ],

  "businessLogic": {
    "rules": [
      "A request cannot be approved if required blood group units are unavailable in inventory.",
      "Once approved, units are reserved (status = Reserved) in bloodinventory until issuance.",
      "Urgent and Emergency requests trigger alerts to technicians for immediate action.",
      "Completed requests link automatically to bloodissuance.json.",
      "Rejected requests remain for audit and cannot be deleted."
    ]
  },

  "reasoning": {
    "businessLogic": "Requests act as the core approval workflow between patient, doctor, and lab. Reservation ensures inventory control and traceability.",
    "uiLogic": "Technicians approve and allocate stock; doctors initiate requests quickly via patient dashboard."
  }
}
