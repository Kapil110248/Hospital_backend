{
  "id": "pharmacysales",
  "title": "Pharmacy Sales",
  "description": "Handles the sale of medicines to patients, links prescriptions, tracks batch-level stock reduction, and automatically generates billing and doctor commission entries.",
  "entity": "PharmacySale",
  "icon": "shopping-cart",
  "version": "1.0.0",
  "module": "Pharmacy Management",

  "permissions": {
    "view": ["Admin", "Pharmacist", "Accountant"],
    "create": ["Pharmacist", "Admin"],
    "edit": ["Pharmacist", "Admin"],
    "delete": ["Admin"]
  },

  "api": {
    "base": "/api/pharmacy/sales",
    "endpoints": {
      "list": { "method": "GET", "path": "/" },
      "get": { "method": "GET", "path": "/:id" },
      "create": { "method": "POST", "path": "/" },
      "update": { "method": "PUT", "path": "/:id" },
      "delete": { "method": "DELETE", "path": "/:id" },
      "invoice": { "method": "GET", "path": "/:id/invoice" },
      "dailySummary": { "method": "GET", "path": "/summary/daily" }
    }
  },

  "fields": [
    { "name": "id", "label": "Sale ID", "type": "uuid", "primary": true, "autoGenerated": true },
    {
      "name": "invoiceNumber",
      "label": "Invoice Number",
      "type": "string",
      "required": true,
      "unique": true,
      "showInList": true
    },
    {
      "name": "patientId",
      "label": "Patient",
      "type": "relation",
      "relationEntity": "patients",
      "relationField": "fullName",
      "widget": "select",
      "required": true,
      "showInList": true
    },
    {
      "name": "doctorId",
      "label": "Prescribed By (Doctor)",
      "type": "relation",
      "relationEntity": "doctors",
      "relationField": "fullName",
      "widget": "select",
      "required": false,
      "showInList": true
    },
    {
      "name": "referralCode",
      "label": "Referral Code",
      "type": "string",
      "placeholder": "Auto-linked from doctor referral (if any)"
    },
    {
      "name": "saleDate",
      "label": "Sale Date",
      "type": "datetime",
      "default": "now",
      "showInList": true
    },
    {
      "name": "paymentMode",
      "label": "Payment Mode",
      "type": "enum",
      "options": ["Cash", "Card", "UPI", "Insurance", "Credit"],
      "default": "Cash",
      "showInList": true
    },
    {
      "name": "items",
      "label": "Sale Items",
      "type": "array",
      "subFields": [
        {
          "name": "stockId",
          "label": "Medicine Batch",
          "type": "relation",
          "relationEntity": "pharmacystock",
          "relationField": "batchNumber",
          "widget": "select"
        },
        { "name": "medicineName", "label": "Medicine Name", "type": "string" },
        { "name": "quantity", "label": "Qty", "type": "number", "required": true },
        { "name": "unitPrice", "label": "Unit Price (₹)", "type": "number", "required": true },
        { "name": "discount", "label": "Discount (%)", "type": "number", "default": 0 },
        {
          "name": "total",
          "label": "Line Total (₹)",
          "type": "computed",
          "formula": "(quantity * unitPrice) - ((discount/100) * (quantity * unitPrice))"
        }
      ],
      "showInList": false
    },
    {
      "name": "subTotal",
      "label": "Subtotal (₹)",
      "type": "computed",
      "formula": "SUM(items.total)",
      "showInList": true
    },
    {
      "name": "tax",
      "label": "GST (%)",
      "type": "number",
      "default": 5
    },
    {
      "name": "taxAmount",
      "label": "Tax Amount (₹)",
      "type": "computed",
      "formula": "(subTotal * tax) / 100"
    },
    {
      "name": "grandTotal",
      "label": "Total Amount (₹)",
      "type": "computed",
      "formula": "subTotal + taxAmount",
      "showInList": true
    },
    {
      "name": "paidAmount",
      "label": "Paid Amount (₹)",
      "type": "number",
      "default": 0
    },
    {
      "name": "balanceAmount",
      "label": "Balance (₹)",
      "type": "computed",
      "formula": "grandTotal - paidAmount"
    },
    {
      "name": "status",
      "label": "Sale Status",
      "type": "enum",
      "options": ["Pending", "Paid", "Partially Paid", "Cancelled"],
      "default": "Pending",
      "showInList": true
    },
    {
      "name": "remarks",
      "label": "Remarks",
      "type": "text",
      "widget": "textarea"
    },
    { "name": "createdAt", "label": "Created At", "type": "datetime", "readOnly": true },
    { "name": "updatedAt", "label": "Updated At", "type": "datetime", "readOnly": true }
  ],

  "relations": [
    { "entity": "patients", "type": "ManyToOne", "foreignKey": "patientId" },
    { "entity": "doctors", "type": "ManyToOne", "foreignKey": "doctorId" },
    { "entity": "pharmacystock", "type": "ManyToMany", "foreignKey": "stockId" },
    { "entity": "billing", "type": "OneToOne", "foreignKey": "saleId" }
  ],

  "ui": {
    "listView": {
      "title": "Pharmacy Sales Overview",
      "columns": ["invoiceNumber", "patientId", "doctorId", "saleDate", "paymentMode", "grandTotal", "status"],
      "filters": ["paymentMode", "status"],
      "searchFields": ["invoiceNumber", "patientId", "doctorId"],
      "actions": ["view", "edit", "delete", "printInvoice"]
    },
    "formView": {
      "title": "New Sale / Edit Sale",
      "layout": [
        ["invoiceNumber", "saleDate"],
        ["patientId", "doctorId", "referralCode"],
        ["paymentMode", "status"],
        ["items"],
        ["subTotal", "tax", "taxAmount", "grandTotal"],
        ["paidAmount", "balanceAmount"],
        ["remarks"]
      ],
      "actions": ["save", "reset", "cancel"]
    },
    "detailView": {
      "title": "Invoice Details",
      "sections": [
        { "title": "Sale Info", "fields": ["invoiceNumber", "saleDate", "patientId", "doctorId", "paymentMode"] },
        { "title": "Items Sold", "fields": ["items"] },
        { "title": "Payment Summary", "fields": ["subTotal", "taxAmount", "grandTotal", "paidAmount", "balanceAmount", "status"] }
      ]
    }
  },

  "actions": [
    {
      "id": "printInvoice",
      "label": "Print Invoice",
      "type": "action",
      "method": "GET",
      "endpoint": "/api/pharmacy/sales/:id/invoice",
      "openIn": "newTab",
      "successMessage": "Invoice opened for print"
    },
    {
      "id": "markAsPaid",
      "label": "Mark as Paid",
      "type": "action",
      "method": "PATCH",
      "endpoint": "/api/pharmacy/sales/:id/status",
      "body": { "status": "Paid" },
      "successMessage": "Sale marked as paid"
    }
  ],

  "businessLogic": {
    "rules": [
      "When sale is created, reduce stock quantities from related PharmacyStock items.",
      "If doctorId is linked to referralCode → auto-generate commission entry in Commission table.",
      "Prevent sale if any selected batch has status 'Expired' or 'Out of Stock'.",
      "Mark sale as 'Paid' only when paidAmount ≥ grandTotal.",
      "Auto-generate linked billing entry and invoice on sale completion."
    ]
  },

  "reasoning": {
    "businessLogic": "Sales directly influence inventory, financials, and commissions. Automating these ensures accuracy and transparency across pharmacy and finance modules.",
    "uiLogic": "Pharmacists perform quick invoice creation; accountants verify payment and audit via reports."
  }
}
